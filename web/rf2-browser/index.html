<link href="../libs/bootstrap/css/bootstrap.css" rel="stylesheet">
<style>
	#holder {
		border: 3px dashed #ccc;
		width: 100%;
		height: 50px;
		text-align: center;
	}
	#holder.hover {
		border-color: #000;
	}
	.nav > li > a {
		padding: 5px;
	}
	.nav {
		overflow: hidden;
	}
	table {
		border: 1px solid lightblue;
		width: 100%;
		font-size: 0.9em;
	}
	.data {
		height: 90%;
	}
	table.data tbody {
		height: 100%;
		overflow: scroll;
		display: block;
	}
	.row {
		margin: 0;
	}
	td {
		padding-right: 3px;
	}
	tr:hover {
		background-color: lightgreen;
	}
	.col-files {
		border-right: 1px solid grey;
		padding: 0px;
	}
	.col-table .header {
		background-color: lightblue;
	}
	.col-table .header tr {
		height: 20px;
	}
	.col-table .header td {
		overflow: hidden;
		position: absolute;
		width: 0px;
		border-right: 1px solid black;
	}
	.col-table .data td {
		border-right: 1px solid lightgrey;
	}
</style>
<div class="container-fluid">
	<div class="row">
		<div class="col-xs-3 col-files">
			<div id="holder">
				<p>Drop RF2 files here</p>
			</div>
			<div>
				<ul class="nav nav-pills nav-stacked">
				</ul>
			</div>
		</div>
		<div class="col-xs-9 col-table">
			<div class="file-view" style="display: none;">
				<table class="header"></table>
				<table class="data"></table>
			</div>
		</div>
	</div>
</div>
<script src="../libs/jquery-2.0.3.js" ></script>
<script src="../libs/handlebars-1.1.2.js"></script>
<script src="../libs/bootstrap/js/tooltip.js"></script>
<script src="../libs/bootstrap/js/popover.js"></script>
<script>

	var conceptLookupKey = 'conceptLookup';
	var fileTypes = [
		{
			key: 'concept',
			match: 'sct2_Concept_.*',
			links: [['moduleId', conceptLookupKey]]
		},
		{
			key: 'desc',
			match: 'sct2_Description_Delta_.*'
		}
	]

	function enable() {
		var holder = $('#holder')[0];
		var textarea = $('#fileData')[0];
		holder.ondragover = function () {
			this.className = 'hover';
			return false;
		};
		holder.ondragend = function () {
			this.className = '';
			return false;
		};
		holder.ondrop = function (e) {
			e.preventDefault();
			this.className = '';

			var files = e.dataTransfer.files;
			for (var f = 0; f < files.length; f++) {
				var file = files[f];
				var reader = new FileReader();
				reader.theFile = file;
				reader.onload = function (event) {
					var file = this.theFile;
					console.log(event.target);
					var fileData = event.target.result;
					addFileItem(file.name, fileData);
				};
				reader.readAsText(file);
			}
		};
	}
	function addFileItem(fileName, fileData) {
		loadFileData(fileName, fileData);

		var $nav = $('.nav');
		var $item = $('<li>').append($('<a>').attr('href', '#').attr('title', fileName).text(fileName)).click(function (e) {
			e.preventDefault();
			var $item = $(this);
			var fileName = $item.data('fileName');
			$('.file-view').hide();
			var $fileView = $('.file-view[fileName="' + fileName + '"]');
			$fileView.show();
			setHeaderColWidths($fileView)
			$nav.find('li').removeClass('active');
			$item.addClass('active');
		});
		$item.data('fileName', fileName);
		$nav.append($item);
		if ($('.nav li').size() == 1) {
			$item.click();
		}
	}
	function loadFileData(fileName, fileData) {
		var thisFileType = null;
		for (var fileType in fileTypes) {
			if (fileName.match(fileType.match)) {
				thisFileType = fileType;
			}
		}

		// Create view div for this file
		var $fileViewTemplate = $('.file-view');
		var $fileView = $fileViewTemplate.first().clone();
		$fileView.attr('fileName', fileName);
		$fileViewTemplate.after($fileView);

		var lines = fileData.split('\n');
		var $headerTable = $fileView.find('table.header');
		var $table = $fileView.find('table.data');
		$headerTable.empty();
		$table.empty();
		if (lines.length > 1) {
			var $headerRow = $('<tr>');

			var headerCols = lines[0].split('\t');
			for (var colIndex = 0; colIndex < headerCols.length; colIndex++) {
				var headerCol = headerCols[colIndex];
				$headerRow.append($('<td>').text(headerCol).attr('title', headerCol));
			}
			$headerTable.append($headerRow);

			for (var lineIndex = 1; lineIndex < lines.length; lineIndex++) {
				var $row = $('<tr>');
				var cols = lines[lineIndex].split('\t');
				addCols(cols, $row);
				$table.append($row);
			}
		}
	}

	function addCols(cols, $row) {
		for (var colIndex = 0; colIndex < cols.length; colIndex++) {
			$row.append($('<td>').text(cols[colIndex]));
		}
	}

	function setHeaderColWidths($fileView) {
		var $headerCols = $fileView.find('.header td');
		var leftColsWidth = 0;
		$fileView.find('.data').find('tr:first').find('td').each(
			function(index) {
				var dataColWidth = new Number($(this).css('width').replace('px', ''));
				console.log(index + ' ' + dataColWidth);
				var $headerCol = $($headerCols[index]);
				$headerCol.css('width', dataColWidth + 'px');
				$headerCol.css('margin-left', leftColsWidth + 'px');
				leftColsWidth += dataColWidth;
			}
		);
	}

	if (window.File && window.FileReader && window.FileList && window.Blob) {
		enable();
	} else {
		alert("Your browser is not supported. Try Chrome.");
	}
</script>
