<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Build Release Package</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="libs/jsonform/deps/opt/bootstrap.css" />
</head>

<body>
<div id="message" class="message"></div>
<div id="error" class="message-error"></div>
<h2 align="center">Build Release Package</h2>
<h6 align="center" style="color: blue">Please login to IMS before using this job</h6>
<div style="width: 80%; margin:0 auto">
    <form></form>
</div>
<script type="text/javascript" src="js/constants.js"></script>
<script type="text/javascript" src="libs/jsonform/deps/jquery.min.js"></script>
<script type="text/javascript" src="libs/jsonform/deps/underscore.js"></script>
<script type="text/javascript" src="libs/jsonform/deps/opt/jsv.js"></script>
<script type="text/javascript" src="libs/jsonform/lib/jsonform.js"></script>
<script type="text/javascript">
   var trackerId;
   var releaseServerUrl;

   var buildJobJsonFormConfig =  {
      "schema": {
         "term_server": {
            "type": "string",
            "enum": [ null, TERM_SERVER_INT_URL, TERM_SERVER_MS_URL],
            "required": true
         },
         "effective_date": {
            "type": "string",
            "description": "Date format: yyyyMMdd",
            "required": true
         },
         "product_name": {
            "type": "string",
            "required": true,
            "enum": []
         },
         "branch_path": {
            "type": "string",
            "required": true
         },
         "export_category": {
            "type": "string",
            "required": true,
            "enum": ["UNPUBLISHED","PUBLISHED","FEEDBACK_FIX"]
         },
         "release_center": {
            "type": "string",
            "required": true,
            "enum": []
         },
         "tracker_id": {
            "type": "string"
         },
         "load_term_server_data": {
            "type": "boolean",
            "default": true,
            "description": "Should be set to true in most cases so that SRS can pull the up-to-date data from Term Server."
         },
         "load_external_data": {
            "type": "boolean",
            "default": true,
            "description": "Should be set to true in most cases so that SRS can pull the up-to-date data from Externally Maintained Bucket"
         },
         "is_snow_owl": {
            "type": "boolean",
            "default": true
         }
      },
      "form" : [
         {
            "type": "fieldset",
            "title": "Release Server Settings",
            "items" : [
              
               {
                  "key": "release_center",
                  "title": "Release Center",
                  "onChange": function(evt) {
                     var value = $(evt.target).val();
                     if (value) {
                        loadProducts(value);
                     }
                  }
               },
               {
                  "key": "product_name",
                  "title": "Product Name",
                  "onChange": function(evt) {
                     var value = $(evt.target).val();
                     if (value) {
                        loadEffectiveDate(value);
                     }
                  }
               }
            ]
         },
         {
           "type": "fieldset",
           "title": "Term Server Settings",
            "items": [
               {
                  "key": "term_server",
                  "title": "Term Server URL"
               },
               {
                  "key": "effective_date",
                  "title": "Effective Date"
               },
               {
                  "key": "branch_path",
                  "title": "Branch Path"
               },
               {
                  "key": "export_category",
                  "title": "Export Category"
               }
            ]
         },
         {
            "type": "fieldset",
            "title": "Advanced Settings",
            "items" : [
               {
                  "key": "load_term_server_data",
                  "title": "Load Term Server Data"
               },
               {
                  "key": "load_external_data",
                  "title": "Load External Bucket Data"
               }
            ]
         },
         {
            "type": "button",
            "title": "Submit",
            "onClick" : function(env) {
               env.preventDefault();
               var values = $("form").jsonFormValue();
               runBuild(values);
            }
         }
      ]
   };
   console.log(window.location.hostname);
   loadReleaseCenters("https://" + window.location.hostname);
   $('form').jsonForm(buildJobJsonFormConfig);

   function runBuild(values) {
      if(validateMandatoryFields()) {
         var trackerUrl = generateTrackerUrl();
         window.open(trackerUrl);
         showNotification("Initializing log....");
         setTimeout(function() {
            var productId = values.product_name.trim().toLocaleLowerCase().replace(/\s+/g,"_");
            var useSnowOwl = values.release_center !== RELEASE_CENTER_INT;
            var configJson = {
               "effectiveDate": values.effective_date,
               "exportCategory": values.export_category,
               "branchPath": values.branch_path,
               "termServerUrl": values.term_server,
               "loadTermServerData": values.load_term_server_data,
               "loadExternalRefsetData": values.load_external_data,
               "trackerId": trackerId,
               "useSnowOwl": useSnowOwl
            };
            var url= releaseServerUrl + "/api/v1/centers/" + values.release_center + "/products/" + productId + "/release";
            $.ajax({
               "type": "POST",
               "url": url,
               "data": JSON.stringify(configJson),
               "contentType": "application/json"
            }).done(function (data) {
               showNotification("Build is started. Please see logs at: " + trackerUrl );
            }).fail(function (xhr, status, e) {
               alert(xhr.status);
            });
         }, 5000)

      }

   }

   function loadReleaseCenters(releaseUrl) {
      releaseServerUrl = releaseUrl;
      showNotification("Loading Release Centers ...");
      var releaseCentersUrl = releaseUrl + "/api/v1/centers";
      $.ajax({
         "type": "GET",
         "url": releaseCentersUrl
      }).done(function (data) {
         console.log(data);
         setDefaultValuesInFormBeforeReset();
         var releaseCenterIds = [null];
         data.forEach(function(value) {
            releaseCenterIds.push(value.id);
         });
         buildJobJsonFormConfig.schema.release_center.enum = releaseCenterIds;
         redrawForm();
      }).fail(function (xhr, status, e) {
         showNotification(status);
      });
   }

   function loadProducts(releaseCenter) {
      showNotification("Loading Products in Release Center " + releaseCenter + " ...");
      var releaseUrl =  releaseServerUrl;
      var productsUrl = releaseUrl + "/api/v1/centers/" + releaseCenter + "/products";
      $.ajax({
         "type": "GET",
         "url": productsUrl
      }).done(function (data) {
         console.log(data);
         setDefaultValuesInFormBeforeReset();
         var products = [];
         data.forEach(function(value) {
            products.push(value.name);
         });
         products.reverse();
         products.unshift(null);
         buildJobJsonFormConfig.schema.product_name.enum = products;
         setTermServerUrl(releaseCenter);
         redrawForm();
      }).fail(function (xhr, status, e) {
         showNotification(status);
      });
   }

   function loadEffectiveDate(productName) {
      showNotification("Loading Effective Date for " + productName + "...");
      var releaseUrl = releaseServerUrl;
      var releaseCenter =  $("form").jsonFormValue().release_center;
      var productId = $("form").jsonFormValue().product_name.trim().toLocaleLowerCase().replace(/\s+/g,"_");
      var productUrl = releaseUrl + "/api/v1/centers/" + releaseCenter + "/products/" + productId;
      $.ajax({
         "type": "GET",
         "url": productUrl
      }).done(function (data) {
         console.log(data);
         setDefaultValuesInFormBeforeReset();
         var productConfig = data.buildConfiguration;
         if(productConfig && productConfig.effectiveTime) {
            buildJobJsonFormConfig.schema.effective_date.default = productConfig.effectiveTime.replace(/-/g,"");
         }
         redrawForm();
      }).fail(function (xhr, status, e) {
         showNotification(status);
      });
   }

   function setTermServerUrl(releaseCenter) {
      if (releaseCenter) {
         if (releaseCenter === RELEASE_CENTER_INT) {
            buildJobJsonFormConfig.schema.term_server.default = TERM_SERVER_INT_URL;
         } else {
            buildJobJsonFormConfig.schema.term_server.default = TERM_SERVER_MS_URL;
         }
      }
   }

   function setDefaultValuesInFormBeforeReset() {
      var values = $("form").jsonFormValue();
      Object.keys(buildJobJsonFormConfig.schema).forEach(function (key){
         buildJobJsonFormConfig.schema[key].default = values[key];
      });
   }

   function validateMandatoryFields() {
      var invalidFields = [];
      var values = $("form").jsonFormValue();
      Object.keys(buildJobJsonFormConfig.schema).forEach(function (key){
         if(!values[key] && buildJobJsonFormConfig.schema[key].required) {
            invalidFields.push(key);
         }
      });
      if (invalidFields.length > 0) {
         showError("Missing mandatory fields: " + invalidFields.join(", "));
         return false;
      }
      return true;
   }

   function generateTrackerUrl() {
      var values = $("form").jsonFormValue();
      var releaseUrl = releaseServerUrl;
      var releaseCenter =  values.release_center;
      var effectiveDate =  values.effective_date;
      var now = Date.now();
      trackerId = releaseCenter + "_" + effectiveDate + "_" + now;
      var url = releaseUrl + "/log.html?trackerId=" + trackerId;
      return url;
   }

   function redrawForm() {
      $('form').empty();
      $('form').jsonForm(buildJobJsonFormConfig);
      hideNotification();
      hideError();
   }

   function showNotification(message) {
      $("#message").html(message);
   }

   function hideNotification() {
      $("#message").html("");
   }

   function showError(message) {
      $("#error").html(message);
   }

   function hideError() {
      $("#error").html("");
   }
</script>
<script type="text/javascript" src="libs/jsonform/lib/jsonform.js"></script>
</body>

</html>