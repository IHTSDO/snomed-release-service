<!DOCTYPE html>
<html lang="en">
<head>
	<link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
	<style>
		html, body, body > .container-fluid, body > .container-fluid > .row, .col-table, .file-view {
			height: 100%;
		}
		#holder {
			border: 3px dashed #ccc;
			width: 100%;
			height: 50px;
			text-align: center;
		}
		#holder.hover {
			border-color: #000;
		}
		.nav > li > a {
			padding: 5px;
		}
		.nav {
			overflow: hidden;
		}
		table {
			border: 1px solid lightblue;
			width: 100%;
			font-size: 0.9em;
		}
		.data {
			height: 90%;
		}
		table.data tbody {
			height: 100%;
			overflow: scroll;
			display: block;
		}
		.row {
			margin: 0;
		}
		td {
			padding-right: 3px;
		}
		tr:hover {
			background-color: lightgreen;
		}
		.col-files {
			border-right: 1px solid grey;
			padding: 0px;
		}
		.col-table .header {
			background-color: lightblue;
		}
		.col-table .header tr {
			height: 20px;
		}
		.col-table .header td {
			overflow: hidden;
			position: absolute;
			width: 0px;
			border-right: 1px solid black;
		}
		.col-table .data td {
			border-right: 1px solid lightgrey;
		}
	</style>
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-xs-3 col-files">
			<div id="holder">
				<p>Drop RF2 files here</p>
			</div>
			<div>
				<ul class="nav nav-pills nav-stacked">
				</ul>
			</div>
		</div>
		<div class="col-xs-9 col-table">
			<div class="file-view" style="display: none;">
				<table class="header"></table>
				<table class="data"></table>
			</div>
		</div>
	</div>
</div>
<script src="http://code.jquery.com/jquery-1.11.0.min.js" ></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script>

function RF2Browser() {

	this.init = function() {
		if (window.File && window.FileReader && window.FileList && window.Blob) {
			doInit();
		} else {
			alert("Your browser is not supported. Try Chrome.");
		}
	}

	var fileTypes = [
		{
			match: 'sct2_Concept_.*',
			conceptLookupCols: ['moduleId', 'definitionStatusId']
		}
	];

	function doInit() {
		var holder = $('#holder')[0];
		holder.ondragover = function () {
			this.className = 'hover';
			return false;
		};
		holder.ondragend = function () {
			this.className = '';
			return false;
		};
		holder.ondrop = function (e) {
			e.preventDefault();
			this.className = '';

			var files = e.dataTransfer.files;
			var readers = [];
			var currentReader = null;
			for (var f = 0; f < files.length; f++) {
				var file = files[f];
				var reader = new FileReader();
				reader.theFile = file;
				reader.onload = function (event) {
					var file = this.theFile;
					var fileData = event.target.result;
					addFileItem(file.name, fileData);

					// Trigger next reader
					currentReader = readers.shift();
					if (currentReader) {
						currentReader.readAsText(currentReader.theFile);
					}
				};
				readers.push(reader);
			}
			currentReader = readers.shift();
			currentReader.readAsText(currentReader.theFile);
		};
	}

	function addFileItem(fileName, fileData) {
		console.log('addFileItem ' + fileName);
		loadFileData(fileName, fileData);
		addFileNav(fileName);
	}

	function loadFileData(fileName, fileData) {
		var fileType = null;
		for (var f = 0; f < fileTypes.length; f++) {
			var aFileType = fileTypes[f];
			if (fileName.match(aFileType.match)) {
				fileType = aFileType;
			}
		}

		// Create view div for this file
		var $fileViewTemplate = $('.file-view').first();
		var $fileView = $fileViewTemplate.clone();
		$fileView.attr('fileName', fileName);
		$fileViewTemplate.after($fileView);

		var lines = fileData.split('\n');
		var $headerTable = $fileView.find('table.header');
		var $table = $fileView.find('table.data');
		$headerTable.empty();
		$table.empty();

		var headerIndexMap = {};
		if (lines.length > 1) {
			var $headerRow = $('<tr>');

			var headerCols = lines[0].split('\t');
			for (var colIndex = 0; colIndex < headerCols.length; colIndex++) {
				var headerCol = headerCols[colIndex].trim();
				$headerRow.append($('<td>').text(headerCol).attr('title', headerCol));
				headerIndexMap[headerCol] = colIndex;
			}
			$headerTable.append($headerRow);

			for (var lineIndex = 1; lineIndex < lines.length; lineIndex++) {
				var $row = $('<tr>');
				var cols = lines[lineIndex].split('\t');
				addCols(cols, $row);
				$table.append($row);
			}
		}

		if (fileType && fileType.conceptLookupCols) {
			var conceptLookupCols = fileType.conceptLookupCols;
			for (var c = 0; c < conceptLookupCols.length; c++) {
				var conceptLookupCol = conceptLookupCols[c];
				var colIndex = headerIndexMap[conceptLookupCol];
				if ($.isNumeric(colIndex)) {
					var colSelectExpression = 'td:nth-child(' + (colIndex + 1) + ') span';
					console.log('colSelectExpression = "' + colSelectExpression + '"');
					var $conceptCols = $table.find(colSelectExpression);
					console.log("$conceptCols = " + $conceptCols.size())
					$conceptCols.each(function() {
						var $cell = $(this);
						var text = $cell.text();
						$cell.tooltip({
							trigger: 'hover',
							title: function() {
								var result = '';
								$.ajax({
									async: false,
									url: 'http://browser.snomedtools.com/version/1/concept/json/' + text,
									success: function(object) {
										result = object.fullySpecifiedName;
									},
									error: function() {
										result = 'Could not load.'
									}
								})
								return result;
							}
						})
					});
				} else {
					console.error('Failed to find column "' + conceptLookupCol + '"');
				}
			}
		}

	}

	function addCols(cols, $row) {
		for (var colIndex = 0; colIndex < cols.length; colIndex++) {
			$row.append($('<td>').append($('<span>').text(cols[colIndex])));
		}
	}

	function addFileNav(fileName) {
		var $nav = $('.nav');
		var $item = $('<li>').append($('<a>').attr('href', '#').attr('title', fileName).text(fileName)).click(function (e) {
			e.preventDefault();
			var $item = $(this);
			var fileName = $item.data('fileName');
			$('.file-view').hide();
			var $fileView = $('.file-view[fileName="' + fileName + '"]');
			$fileView.show();
			setHeaderColWidths($fileView)
			$nav.find('li').removeClass('active');
			$item.addClass('active');
		});
		$item.data('fileName', fileName);
		$nav.append($item);
		if ($('.nav li').size() == 1) {
			$item.click();
		}
	}

	function setHeaderColWidths($fileView) {
		var $headerCols = $fileView.find('.header td');
		var leftColsWidth = 0;
		$fileView.find('.data').find('tr:first').find('td').each(
			function(index) {
				var dataColWidth = new Number($(this).css('width').replace('px', ''));
				var $headerCol = $($headerCols[index]);
				$headerCol.css('width', dataColWidth + 'px');
				$headerCol.css('margin-left', leftColsWidth + 'px');
				leftColsWidth += dataColWidth;
			}
		);
	}

}

new RF2Browser().init();

</script>
</body>
</html>